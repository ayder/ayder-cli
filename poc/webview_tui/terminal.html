<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ayder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; background: #0d0d1a; overflow: hidden; }
        #terminal { height: 100%; width: 100%; }
        #status {
            display: none;
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 4px 12px;
            background: #12122a; color: #555570;
            font: 12px monospace; text-align: center;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>
    <div id="status"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-webgl@0.16.0/lib/xterm-addon-webgl.min.js"></script>

    <script>
        const WS_PORT = {{WS_PORT}};

        // ── Terminal setup ──────────────────────────────────────
        const term = new Terminal({
            cursorBlink: true,
            cursorStyle: 'bar',
            fontSize: 14,
            fontFamily: '"JetBrains Mono", "Cascadia Code", "Fira Code", Menlo, Consolas, monospace',
            theme: {
                background:       '#0d0d1a',
                foreground:       '#e0e0e8',
                cursor:           '#5eaff5',
                cursorAccent:     '#0d0d1a',
                selectionBackground: '#264f78',
                black:            '#1a1a2e',
                red:              '#ff6b6b',
                green:            '#51cf66',
                yellow:           '#ffd43b',
                blue:             '#5eaff5',
                magenta:          '#cc5de8',
                cyan:             '#66d9e8',
                white:            '#e0e0e8',
                brightBlack:      '#555570',
                brightRed:        '#ff8787',
                brightGreen:      '#69db7c',
                brightYellow:     '#ffe066',
                brightBlue:       '#74c0fc',
                brightMagenta:    '#da77f2',
                brightCyan:       '#99e9f2',
                brightWhite:      '#ffffff',
            },
            allowProposedApi: true,
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        try {
            const webglAddon = new WebglAddon.WebglAddon();
            webglAddon.onContextLoss(() => webglAddon.dispose());
            term.loadAddon(webglAddon);
        } catch (_) {
            // Canvas renderer fallback — fine for a POC
        }

        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        // ── WebSocket bridge ────────────────────────────────────
        const statusEl = document.getElementById('status');
        let ws = null;

        function showStatus(msg) {
            statusEl.textContent = msg;
            statusEl.style.display = 'block';
        }
        function hideStatus() { statusEl.style.display = 'none'; }

        function sendCtrl(obj) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('\x00' + JSON.stringify(obj));
            }
        }

        function connect() {
            ws = new WebSocket('ws://127.0.0.1:' + WS_PORT);

            ws.onopen = () => {
                hideStatus();
                sendCtrl({ type: 'resize', cols: term.cols, rows: term.rows });
                term.focus();
            };

            ws.onmessage = (ev) => term.write(ev.data);

            ws.onclose = () => {
                showStatus('Session ended. Close the window or press Ctrl+R to reconnect.');
            };

            ws.onerror = () => {};
        }

        // Terminal input → PTY
        term.onData((data) => {
            if (ws && ws.readyState === WebSocket.OPEN) ws.send(data);
        });

        // Resize handling
        const resizeObserver = new ResizeObserver(() => {
            fitAddon.fit();
            sendCtrl({ type: 'resize', cols: term.cols, rows: term.rows });
        });
        resizeObserver.observe(document.getElementById('terminal'));

        connect();
    </script>
</body>
</html>
